<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Space COYS - Mental Health Support for Spurs Fans</title>
    <meta name="description" content="A supportive mental health space for Tottenham Hotspur fans.">
    <meta name="theme-color" content="#132257">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêì</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root{--spurs-navy:#132257;--spurs-white:#FFF;--spurs-gold:#D4AF37;--spurs-light-navy:#1a2d6b;--bg-dark:#0a0f1c;--bg-card:#111827;--bg-card-hover:#1f2937;--text-primary:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;--border-color:#374151;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;line-height:1.6}
        a{color:var(--spurs-gold);text-decoration:none}button{cursor:pointer;font-family:inherit}
        .skip-link{position:absolute;top:-40px;left:0;background:var(--spurs-navy);color:var(--spurs-white);padding:8px 16px;z-index:100}.skip-link:focus{top:0}
        header{background:linear-gradient(135deg,var(--spurs-navy),var(--spurs-light-navy));padding:1rem;text-align:center;position:sticky;top:0;z-index:50;border-bottom:2px solid var(--spurs-gold)}
        .logo{display:flex;align-items:center;justify-content:center;gap:.5rem}.logo-icon{font-size:2rem}.logo-text{font-size:1.25rem;font-weight:700}.logo-text span{display:block;font-size:.75rem;font-weight:400;color:var(--text-secondary)}
        .match-widget{background:var(--bg-card);border-radius:12px;padding:1rem;margin:1rem;border:1px solid var(--border-color)}.match-widget h2{font-size:.875rem;color:var(--text-secondary);margin-bottom:.75rem;text-align:center}.match-teams{display:flex;align-items:center;justify-content:center;gap:1rem;margin-bottom:.75rem}.team{display:flex;align-items:center;gap:.5rem;font-weight:600}.team-badge{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem}.match-info{display:flex;justify-content:center;gap:1rem;font-size:.75rem;color:var(--text-muted)}.countdown{display:flex;justify-content:center;gap:.5rem;margin-top:.75rem}.countdown-item{text-align:center;background:var(--spurs-navy);padding:.5rem;border-radius:8px;min-width:50px}.countdown-value{font-size:1.25rem;font-weight:700;color:var(--spurs-gold)}.countdown-label{font-size:.625rem;color:var(--text-muted);text-transform:uppercase}.trophy-drought{text-align:center;padding:.75rem;background:linear-gradient(90deg,transparent,rgba(212,175,55,.1),transparent);border-radius:8px;margin-top:.75rem}.drought-days{font-size:1.5rem;font-weight:700;color:var(--spurs-gold)}.drought-label{font-size:.75rem;color:var(--text-muted)}
        .desktop-nav{display:none;background:var(--bg-card);border-radius:12px;margin:0 1rem;padding:.5rem;border:1px solid var(--border-color)}.nav-section{margin-bottom:.5rem}.nav-section-title{font-size:.625rem;color:var(--text-muted);text-transform:uppercase;padding:.5rem 1rem}.nav-items{display:flex;flex-direction:column}.nav-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:8px;color:var(--text-secondary);transition:all .2s;border:none;background:none;width:100%;text-align:left;font-size:.875rem}.nav-item:hover,.nav-item.active{background:var(--spurs-navy);color:var(--text-primary)}.nav-item.active{color:var(--spurs-gold)}
        .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;padding:.5rem 0;padding-bottom:calc(.5rem + env(safe-area-inset-bottom));z-index:50}.mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:.25rem;padding:.5rem 1rem;color:var(--text-muted);background:none;border:none;font-size:.625rem}.mobile-nav-item .icon{font-size:1.25rem}.mobile-nav-item.active{color:var(--spurs-gold)}
        main{padding:1rem;padding-bottom:5rem;max-width:800px;margin:0 auto}.page{display:none}.page.active{display:block}.page-title{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}.page-subtitle{color:var(--text-secondary);margin-bottom:1.5rem}
        .mood-question{text-align:center;margin-bottom:1.5rem}.mood-question h2{font-size:1.125rem;color:var(--text-secondary);margin-bottom:.5rem}.mood-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:2rem}.mood-btn{background:var(--bg-card);border:2px solid var(--border-color);border-radius:12px;padding:1rem .5rem;text-align:center;transition:all .2s;cursor:pointer}.mood-btn:hover,.mood-btn:focus{border-color:var(--spurs-gold);transform:translateY(-2px)}.mood-btn .emoji{font-size:2rem;display:block;margin-bottom:.5rem}.mood-btn .label{font-weight:600;font-size:.875rem;color:var(--text-primary)}.mood-btn .desc{font-size:.75rem;color:var(--text-muted);margin-top:.25rem}
        .quick-tools h3{font-size:1rem;margin-bottom:1rem;color:var(--text-secondary)}.tools-row{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}.tool-btn{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:1rem;display:flex;align-items:center;gap:.75rem;transition:all .2s;color:var(--text-primary)}.tool-btn:hover{background:var(--bg-card-hover);border-color:var(--spurs-gold)}.tool-btn .icon{font-size:1.5rem}.tool-btn .info{text-align:left}.tool-btn .name{font-weight:600;font-size:.875rem}.tool-btn .duration{font-size:.75rem;color:var(--text-muted)}
        .toolkit-grid{display:grid;gap:1rem}.toolkit-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:1.5rem;transition:all .2s}.toolkit-card:hover{border-color:var(--spurs-gold)}.toolkit-card-header{display:flex;align-items:flex-start;gap:1rem;margin-bottom:1rem}.toolkit-card-icon{font-size:2rem;background:var(--spurs-navy);padding:.75rem;border-radius:12px}.toolkit-card-meta{font-size:.75rem;color:var(--spurs-gold);margin-bottom:.25rem}.toolkit-card h3{font-size:1.125rem}.toolkit-card p{color:var(--text-secondary);font-size:.875rem;margin-bottom:1rem}.toolkit-card-btn{background:var(--spurs-navy);color:var(--text-primary);border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600}.toolkit-card-btn:hover{background:var(--spurs-light-navy)}
        .community-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem}.category-filters{display:flex;gap:.5rem;overflow-x:auto;padding-bottom:.5rem;margin-bottom:1rem}.category-filter{background:var(--bg-card);border:1px solid var(--border-color);color:var(--text-secondary);padding:.5rem 1rem;border-radius:20px;font-size:.75rem;white-space:nowrap}.category-filter:hover,.category-filter.active{background:var(--spurs-navy);border-color:var(--spurs-gold);color:var(--text-primary)}.new-post-btn{background:var(--spurs-gold);color:var(--spurs-navy);border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;display:flex;align-items:center;gap:.5rem}.new-post-btn:disabled{opacity:.5;cursor:not-allowed}
        .post-composer{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:1rem;margin-bottom:1rem;display:none}.post-composer.active{display:block}.post-composer textarea{width:100%;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;padding:1rem;color:var(--text-primary);font-size:1rem;resize:vertical;min-height:100px;margin-bottom:1rem}.post-composer textarea:focus{outline:none;border-color:var(--spurs-gold)}.composer-options{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem}.composer-select{background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;padding:.5rem 1rem;color:var(--text-primary);font-size:.875rem}.composer-checkbox{display:flex;align-items:center;gap:.5rem;color:var(--text-secondary);font-size:.875rem}.composer-checkbox input{width:18px;height:18px;accent-color:var(--spurs-gold)}.composer-actions{display:flex;justify-content:flex-end;gap:.75rem}.composer-cancel{background:transparent;border:1px solid var(--border-color);color:var(--text-secondary);padding:.75rem 1.5rem;border-radius:8px}.composer-submit{background:var(--spurs-gold);color:var(--spurs-navy);border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600}.composer-submit:disabled{opacity:.5;cursor:not-allowed}
        .posts-list{display:flex;flex-direction:column;gap:1rem}.post-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:1rem}.post-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem}.post-author{display:flex;align-items:center;gap:.75rem}.author-avatar{width:40px;height:40px;border-radius:50%;background:var(--spurs-navy);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.875rem}.author-info{display:flex;flex-direction:column}.author-name{font-weight:600;font-size:.875rem}.post-meta{font-size:.75rem;color:var(--text-muted);display:flex;align-items:center;gap:.5rem}.post-category{background:var(--spurs-navy);padding:.125rem .5rem;border-radius:4px;font-size:.625rem;text-transform:uppercase}.post-type-badge{padding:.25rem .5rem;border-radius:4px;font-size:.75rem}.post-type-badge.vent{background:rgba(239,68,68,.2);color:var(--danger)}.post-type-badge.support{background:rgba(16,185,129,.2);color:var(--success)}.post-menu{position:relative}.post-menu-btn{background:transparent;border:none;color:var(--text-muted);padding:.5rem;border-radius:4px}.post-menu-btn:hover{background:var(--bg-card-hover)}.post-menu-dropdown{position:absolute;right:0;top:100%;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;padding:.5rem;min-width:120px;display:none;z-index:10}.post-menu-dropdown.active{display:block}.post-menu-item{display:block;width:100%;text-align:left;background:none;border:none;color:var(--text-primary);padding:.5rem .75rem;border-radius:4px;font-size:.875rem}.post-menu-item:hover{background:var(--bg-card-hover)}.post-menu-item.danger{color:var(--danger)}.post-content{margin-bottom:1rem;line-height:1.6;white-space:pre-wrap}.post-actions{display:flex;gap:1rem;padding-top:.75rem;border-top:1px solid var(--border-color)}.post-action-btn{display:flex;align-items:center;gap:.5rem;background:none;border:none;color:var(--text-muted);font-size:.875rem;padding:.5rem;border-radius:8px}.post-action-btn:hover{background:var(--bg-card-hover);color:var(--text-primary)}.post-action-btn.liked{color:var(--danger)}
        .comments-section{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border-color);display:none}.comments-section.active{display:block}.comment{padding:.75rem 0;border-bottom:1px solid var(--border-color)}.comment:last-child{border-bottom:none}.comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.comment-author{display:flex;align-items:center;gap:.5rem}.comment-avatar{width:28px;height:28px;border-radius:50%;background:var(--spurs-navy);display:flex;align-items:center;justify-content:center;font-size:.75rem}.comment-author-name{font-weight:600;font-size:.8125rem}.comment-time{font-size:.75rem;color:var(--text-muted)}.comment-content{font-size:.875rem;margin-left:36px}.comment-actions{margin-left:36px;margin-top:.5rem}.reply-btn{background:none;border:none;color:var(--text-muted);font-size:.75rem;cursor:pointer;margin-right:.5rem}.reply-btn:hover{color:var(--spurs-gold)}.nested-comments{margin-left:2rem;padding-left:1rem;border-left:2px solid var(--border-color)}.comment-form{display:flex;gap:.75rem;margin-top:1rem}.comment-input{flex:1;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;padding:.75rem;color:var(--text-primary);font-size:.875rem}.comment-input:focus{outline:none;border-color:var(--spurs-gold)}.comment-submit{background:var(--spurs-navy);color:var(--text-primary);border:none;padding:.75rem 1rem;border-radius:8px;font-weight:600}.comment-submit:disabled{opacity:.5}
        .loading-spinner{display:flex;justify-content:center;padding:2rem}.spinner{width:40px;height:40px;border:3px solid var(--border-color);border-top-color:var(--spurs-gold);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.empty-state{text-align:center;padding:3rem 1rem;color:var(--text-muted)}.empty-state-icon{font-size:3rem;margin-bottom:1rem}
        .profile-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:1.5rem;text-align:center;margin-bottom:1.5rem}.profile-avatar{width:80px;height:80px;border-radius:50%;background:var(--spurs-navy);display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 1rem;border:3px solid var(--spurs-gold)}.profile-name{font-size:1.25rem;font-weight:700;margin-bottom:.25rem}.profile-email{color:var(--text-muted);font-size:.875rem;margin-bottom:.5rem}.profile-since{color:var(--text-secondary);font-size:.75rem}.logout-btn{background:transparent;border:1px solid var(--danger);color:var(--danger);padding:.5rem 1.5rem;border-radius:8px;margin-top:1rem;font-size:.875rem}.logout-btn:hover{background:var(--danger);color:var(--text-primary)}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.5rem}.stat-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:1rem;text-align:center}.stat-value{font-size:1.5rem;font-weight:700;color:var(--spurs-gold)}.stat-label{font-size:.75rem;color:var(--text-muted);margin-top:.25rem}
        .mood-chart-container{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:1rem;margin-bottom:1.5rem}.mood-chart-title{font-size:.875rem;color:var(--text-secondary);margin-bottom:1rem}.mood-chart{height:120px;display:flex;align-items:flex-end;gap:.5rem}.mood-bar{flex:1;background:var(--spurs-navy);border-radius:4px 4px 0 0;min-height:10px}.mood-chart-placeholder{color:var(--text-muted);font-size:.875rem;text-align:center;padding:2rem}
        .recent-checkins h3{font-size:1rem;margin-bottom:1rem}.checkin-item{display:flex;align-items:center;gap:1rem;padding:.75rem;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;margin-bottom:.5rem}.checkin-emoji{font-size:1.5rem}.checkin-info{flex:1}.checkin-emotion{font-weight:600;font-size:.875rem}.checkin-meta{font-size:.75rem;color:var(--text-muted)}.checkin-intensity{font-weight:600;color:var(--spurs-gold)}
        .auth-prompt{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:2rem;text-align:center}.auth-prompt .icon{font-size:3rem;margin-bottom:1rem}.auth-prompt h2{font-size:1.25rem;margin-bottom:.5rem}.auth-prompt p{color:var(--text-secondary);margin-bottom:1.5rem}.auth-btn{background:var(--spurs-gold);color:var(--spurs-navy);border:none;padding:.875rem 2rem;border-radius:8px;font-weight:600;font-size:1rem}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;padding:1rem}.modal-overlay.active{display:flex}.modal{background:var(--bg-card);border-radius:16px;max-width:400px;width:100%;max-height:90vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border-color)}.modal-title{font-size:1.125rem;font-weight:600}.modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;padding:.5rem}.modal-body{padding:1.5rem}
        .auth-logo{text-align:center;margin-bottom:1.5rem}.auth-logo .icon{font-size:2.5rem}.auth-logo h3{font-size:1.125rem;margin-top:.5rem}.auth-form{display:flex;flex-direction:column;gap:1rem}.form-group{display:flex;flex-direction:column;gap:.5rem}.form-group label{font-size:.875rem;color:var(--text-secondary)}.form-group input{background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;padding:.875rem;color:var(--text-primary);font-size:1rem}.form-group input:focus{outline:none;border-color:var(--spurs-gold)}.auth-submit{background:var(--spurs-gold);color:var(--spurs-navy);border:none;padding:.875rem;border-radius:8px;font-weight:600;font-size:1rem;margin-top:.5rem}.auth-submit:disabled{opacity:.5;cursor:not-allowed}.auth-benefits{margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border-color)}.auth-benefits p{font-size:.875rem;color:var(--text-secondary);margin-bottom:.75rem}.auth-benefits ul{list-style:none}.auth-benefits li{font-size:.875rem;color:var(--text-muted);padding:.25rem 0}.auth-benefits li::before{content:"‚úì ";color:var(--success)}
        .magic-link-sent{text-align:center;display:none}.magic-link-sent.active{display:block}.magic-link-sent .icon{font-size:3rem;margin-bottom:1rem}.magic-link-sent h3{margin-bottom:.5rem}.magic-link-sent p{color:var(--text-secondary);font-size:.875rem}.magic-link-sent .email{color:var(--spurs-gold);font-weight:600}.resend-link{margin-top:1rem;font-size:.875rem;color:var(--text-muted)}.resend-link button{background:none;border:none;color:var(--spurs-gold);text-decoration:underline;cursor:pointer}
        .selected-mood{margin-bottom:1.5rem;text-align:center}.selected-mood .emoji{font-size:3rem}.intensity-slider{margin:1.5rem 0}.intensity-slider label{display:block;font-size:.875rem;color:var(--text-secondary);margin-bottom:.75rem}.intensity-slider input[type="range"]{width:100%;accent-color:var(--spurs-gold)}.intensity-labels{display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-muted);margin-top:.5rem}.trigger-options{margin:1.5rem 0}.trigger-options label{display:block;font-size:.875rem;color:var(--text-secondary);margin-bottom:.75rem;text-align:left}.trigger-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}.trigger-btn{background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;padding:.5rem;font-size:.75rem;color:var(--text-secondary)}.trigger-btn:hover,.trigger-btn.active{border-color:var(--spurs-gold);color:var(--text-primary)}.checkin-actions{display:flex;gap:.75rem;margin-top:1.5rem}.checkin-actions button{flex:1;padding:.875rem;border-radius:8px;font-weight:600}.checkin-back{background:transparent;border:1px solid var(--border-color);color:var(--text-secondary)}.checkin-save{background:var(--spurs-gold);border:none;color:var(--spurs-navy)}
        .tool-modal .modal{max-width:500px}.breathing-circle{width:200px;height:200px;border-radius:50%;background:var(--spurs-navy);margin:2rem auto;display:flex;align-items:center;justify-content:center;font-size:1.25rem;text-align:center;padding:1rem;transition:transform 4s ease-in-out}.breathing-circle.inhale{transform:scale(1.3)}.tool-nav{display:flex;justify-content:center;gap:.75rem;margin-top:1.5rem}.tool-nav button{padding:.75rem 1.5rem;border-radius:8px;font-weight:600}.tool-prev{background:transparent;border:1px solid var(--border-color);color:var(--text-secondary)}.tool-next{background:var(--spurs-gold);border:none;color:var(--spurs-navy)}.affirmation-card{background:var(--spurs-navy);border-radius:12px;padding:2rem;margin:1.5rem 0;font-size:1.125rem;line-height:1.6;text-align:center}.thought-reframe textarea{width:100%;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;padding:1rem;color:var(--text-primary);min-height:100px;resize:vertical;margin:1rem 0}
        .toast-container{position:fixed;bottom:5rem;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:.5rem}.toast{background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;padding:.875rem 1.5rem;display:flex;align-items:center;gap:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.3);animation:slideUp .3s ease}.toast.success{border-color:var(--success)}.toast.error{border-color:var(--danger)}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @media(min-width:768px){.desktop-nav{display:block}.mobile-nav{display:none}main{padding-bottom:2rem}.mood-grid{grid-template-columns:repeat(6,1fr)}.tools-row{grid-template-columns:repeat(4,1fr)}.stats-grid{grid-template-columns:repeat(4,1fr)}}
        @media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}:focus-visible{outline:2px solid var(--spurs-gold);outline-offset:2px}
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Skip to main content</a>
    <header><div class="logo"><span class="logo-icon">üêì</span><div class="logo-text">Safe Space <br>COYS<span>A sanctuary for the long-suffering</span></div></div></header>
    <div class="match-widget"><h2>Next Match</h2><div class="match-teams"><div class="team"><div class="team-badge" style="background:var(--spurs-white);color:var(--spurs-navy)">ü§ç</div><span>Spurs</span></div><span>vs</span><div class="team"><span>Man City</span><div class="team-badge" style="background:#6CABDD">üîµ</div></div></div><div class="match-info"><span>üìç Emirates</span><span>üèÜ PL</span></div><div class="countdown"><div class="countdown-item"><div class="countdown-value" id="countDays">-</div><div class="countdown-label">Days</div></div><div class="countdown-item"><div class="countdown-value" id="countHours">-</div><div class="countdown-label">Hrs</div></div><div class="countdown-item"><div class="countdown-value" id="countMins">-</div><div class="countdown-label">Min</div></div><div class="countdown-item"><div class="countdown-value" id="countSecs">-</div><div class="countdown-label">Sec</div></div></div><div class="trophy-drought"><div class="drought-days" id="droughtDays">6,205</div><div class="drought-label">days without a trophy</div></div></div>
    <nav class="desktop-nav"><div class="nav-section"><div class="nav-section-title">Main</div><div class="nav-items"><button class="nav-item active" data-page="home">üè† Home</button><button class="nav-item" data-page="toolkit">üß∞ Coping Toolkit</button><button class="nav-item" data-page="community">üë• Community</button></div></div><div class="nav-section"><div class="nav-section-title">Personal</div><div class="nav-items"><button class="nav-item" data-page="profile">üë§ My Profile</button></div></div></nav>
    <main id="main">
        <section class="page active" id="page-home"><h1 class="page-title">How are you holding up?</h1><p class="page-subtitle">Take a moment to check in with yourself.</p><div class="mood-question"><h2>How Spursy are you feeling today?</h2><p class="page-subtitle">Select an emotion to start your check-in</p></div><div class="mood-grid"><button class="mood-btn" data-mood="frustrated" data-emoji="üò§"><span class="emoji">üò§</span><span class="label">Frustrated</span><span class="desc">"Same old story"</span></button><button class="mood-btn" data-mood="anxious" data-emoji="üò∞"><span class="emoji">üò∞</span><span class="label">Anxious</span><span class="desc">"2-0 lead energy"</span></button><button class="mood-btn" data-mood="sad" data-emoji="üòî"><span class="emoji">üòî</span><span class="label">Sad</span><span class="desc">"Post-match blues"</span></button><button class="mood-btn" data-mood="numb" data-emoji="üòê"><span class="emoji">üòê</span><span class="label">Numb</span><span class="desc">"Can't hurt anymore"</span></button><button class="mood-btn" data-mood="hopeful" data-emoji="ü§û"><span class="emoji">ü§û</span><span class="label">Hopeful</span><span class="desc">"This is our year"</span></button><button class="mood-btn" data-mood="content" data-emoji="üòä"><span class="emoji">üòä</span><span class="label">Content</span><span class="desc">"Win or lose, COYS"</span></button></div><div class="quick-tools"><h3>Quick Coping Tools</h3><div class="tools-row"><button class="tool-btn" data-tool="breathing"><span class="icon">üå¨Ô∏è</span><div class="info"><div class="name">Box Breathing</div><div class="duration">1 min</div></div></button><button class="tool-btn" data-tool="grounding"><span class="icon">üéØ</span><div class="info"><div class="name">5-4-3-2-1 Ground</div><div class="duration">2 min</div></div></button><button class="tool-btn" data-tool="reframe"><span class="icon">üß†</span><div class="info"><div class="name">Thought Reframe</div><div class="duration">3 min</div></div></button><button class="tool-btn" data-tool="affirmations"><span class="icon">üí™</span><div class="info"><div class="name">Affirmations</div><div class="duration">30 sec</div></div></button></div></div></section>
        <section class="page" id="page-toolkit"><h1 class="page-title">Coping Toolkit</h1><p class="page-subtitle">Evidence-based techniques for the long-suffering fan</p><div class="toolkit-grid"><div class="toolkit-card"><div class="toolkit-card-header"><div class="toolkit-card-icon">üå¨Ô∏è</div><div><div class="toolkit-card-meta">Breathing</div><h3>Box Breathing</h3></div></div><p>A clinically-proven 4-4-4-4 breathing technique to calm your nervous system.</p><button class="toolkit-card-btn" data-tool="breathing">Start Exercise</button></div><div class="toolkit-card"><div class="toolkit-card-header"><div class="toolkit-card-icon">üéØ</div><div><div class="toolkit-card-meta">Grounding</div><h3>5-4-3-2-1 Technique</h3></div></div><p>Ground yourself in the present moment when anxiety takes over.</p><button class="toolkit-card-btn" data-tool="grounding">Start Exercise</button></div><div class="toolkit-card"><div class="toolkit-card-header"><div class="toolkit-card-icon">üß†</div><div><div class="toolkit-card-meta">CBT</div><h3>Thought Reframing</h3></div></div><p>"We always bottle it" - Let's examine this thought with CBT techniques.</p><button class="toolkit-card-btn" data-tool="reframe">Start Exercise</button></div><div class="toolkit-card"><div class="toolkit-card-header"><div class="toolkit-card-icon">üí™</div><div><div class="toolkit-card-meta">Positive Psychology</div><h3>Spurs Fan Affirmations</h3></div></div><p>Positive statements designed specifically for the Spurs fan experience.</p><button class="toolkit-card-btn" data-tool="affirmations">View Affirmations</button></div></div></section>
        <section class="page" id="page-community"><h1 class="page-title">Community</h1><p class="page-subtitle">A safe space for fellow sufferers.</p><div class="community-header"><div class="category-filters"><button class="category-filter active" data-category="all">All Posts</button><button class="category-filter" data-category="match_day">Match Day</button><button class="category-filter" data-category="mental_health">Mental Health</button><button class="category-filter" data-category="general">General Chat</button><button class="category-filter" data-category="support_needed">Support Needed</button><button class="category-filter" data-category="celebrations">Celebrations</button></div><button class="new-post-btn" id="newPostBtn">‚úçÔ∏è New Post</button></div><div class="post-composer" id="postComposer"><textarea id="postContent" placeholder="What's on your mind, fellow Yiddo?" maxlength="2000"></textarea><div class="composer-options"><select class="composer-select" id="postCategory"><option value="general">General Chat</option><option value="match_day">Match Day</option><option value="mental_health">Mental Health</option><option value="support_needed">Support Needed</option><option value="celebrations">Celebrations</option></select><select class="composer-select" id="postType"><option value="support">ü§ù Support</option><option value="vent">üò§ Vent</option></select><label class="composer-checkbox"><input type="checkbox" id="postAnonymous"> Post anonymously</label></div><div class="composer-actions"><button class="composer-cancel" id="cancelPost">Cancel</button><button class="composer-submit" id="submitPost">Post</button></div></div><div class="posts-list" id="postsList"><div class="loading-spinner"><div class="spinner"></div></div></div></section>
        <section class="page" id="page-profile"><h1 class="page-title">My Profile</h1><p class="page-subtitle">Your personal dashboard and check-in history</p><div class="auth-prompt" id="authPrompt"><div class="icon">üîí</div><h2>Join the Safe Space</h2><p>Sign in to track your mood history, see your stats, and connect with the community.</p><button class="auth-btn" id="openAuthModal">Sign In with Email</button></div><div id="profileContent" style="display:none"><div class="profile-card"><div class="profile-avatar" id="profileAvatar">FS</div><div class="profile-name" id="profileName">Fellow Sufferer</div><div class="profile-email" id="profileEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="691c1a0c1b290c11080419050c470a0604">[email&#160;protected]</a></div><div class="profile-since" id="profileSince">üêì Suffering since joining</div><button class="logout-btn" id="logoutBtn">Log Out</button></div><div class="stats-grid"><div class="stat-card"><div class="stat-value" id="statCheckins">0</div><div class="stat-label">Check-ins</div></div><div class="stat-card"><div class="stat-value" id="statStreak">0</div><div class="stat-label">Day Streak</div></div><div class="stat-card"><div class="stat-value" id="statTools">0</div><div class="stat-label">Tools Used</div></div><div class="stat-card"><div class="stat-value" id="statAvgMood">--</div><div class="stat-label">Avg Mood</div></div></div><div class="mood-chart-container"><div class="mood-chart-title">Last 7 Days Mood Intensity</div><div class="mood-chart" id="moodChart"><div class="mood-chart-placeholder">Complete more check-ins to see your trend</div></div></div><div class="recent-checkins"><h3>Recent Check-ins</h3><div id="recentCheckinsList"></div></div></div></section>
    </main>
    <nav class="mobile-nav"><button class="mobile-nav-item active" data-page="home"><span class="icon">üè†</span><span>Home</span></button><button class="mobile-nav-item" data-page="toolkit"><span class="icon">üß∞</span><span>Tools</span></button><button class="mobile-nav-item" data-page="community"><span class="icon">üë•</span><span>Community</span></button><button class="mobile-nav-item" data-page="profile"><span class="icon">üë§</span><span>Profile</span></button></nav>
    <div class="modal-overlay" id="authModal"><div class="modal"><div class="modal-header"><h2 class="modal-title">Join the Safe Space</h2><button class="modal-close">&times;</button></div><div class="modal-body"><div id="authForm"><div class="auth-logo"><div class="icon">üêì</div><h3>Welcome, Fellow Sufferer</h3></div><p style="text-align:center;color:var(--text-secondary);margin-bottom:1.5rem">Enter your email to join. We'll send you a magic link - no password needed.</p><form class="auth-form" id="magicLinkForm"><div class="form-group"><label for="authEmail">Email Address</label><input type="email" id="authEmail" required placeholder="you@example.com"></div><button type="submit" class="auth-submit" id="authSubmitBtn">Send Magic Link</button></form><div class="auth-benefits"><p>With an account you can:</p><ul><li>Track your mood history over time</li><li>See your personal stats and insights</li><li>Connect with the community</li></ul></div></div><div class="magic-link-sent" id="magicLinkSent"><div class="icon">üì¨</div><h3>Check Your Inbox</h3><p>We've sent a magic link to<br><span class="email" id="sentEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d0a9bfa590b5a8b1bda0bcb5feb3bfbd">[email&#160;protected]</a></span></p><p style="margin-top:.5rem">Click the link to join. Expires in 24 hours.</p><div class="resend-link">Didn't receive it? <button id="resendLink">Resend</button></div></div></div></div></div>
    <div class="modal-overlay" id="moodModal"><div class="modal"><div class="modal-header"><h2 class="modal-title">Mood Check-in</h2><button class="modal-close">&times;</button></div><div class="modal-body"><div class="selected-mood"><div class="emoji" id="selectedMoodEmoji">üò∞</div><h3>You selected: <span id="selectedMoodLabel">Anxious</span></h3></div><div class="intensity-slider"><label>How intense is this feeling?</label><p style="font-size:.75rem;color:var(--text-muted)">1 = barely noticeable, 10 = overwhelming</p><input type="range" id="intensitySlider" min="1" max="10" value="5"><div class="intensity-labels"><span>Manageable</span><span>Moderate</span><span>Overwhelming</span></div></div><div class="trigger-options"><label>What triggered this?</label><p style="font-size:.75rem;color:var(--text-muted);margin-bottom:.5rem">Optional - helps identify patterns</p><div class="trigger-grid"><button class="trigger-btn" data-trigger="match_result">‚öΩ Match Result</button><button class="trigger-btn" data-trigger="var">üì∫ VAR Decision</button><button class="trigger-btn" data-trigger="transfer">üîÑ Transfer News</button><button class="trigger-btn" data-trigger="derby">üèüÔ∏è Derby Day</button><button class="trigger-btn" data-trigger="social_media">üì± Social Media</button><button class="trigger-btn" data-trigger="general">üí≠ General Life</button></div></div><div class="checkin-actions"><button class="checkin-back" id="checkinBack">Back</button><button class="checkin-save" id="checkinSave">Save Check-in</button></div></div></div></div>
    <div class="modal-overlay tool-modal" id="toolModal"><div class="modal"><div class="modal-header"><h2 class="modal-title" id="toolModalTitle">Tool</h2><button class="modal-close">&times;</button></div><div class="modal-body"><div class="tool-content" id="toolContent"></div></div></div></div>
    <div class="toast-container" id="toastContainer"></div>
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        const SUPABASE_URL='https://bjodaghpowjqnlhclbdg.supabase.co';
        const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqb2RhZ2hwb3dqcW5saGNsYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDU3MzgsImV4cCI6MjA4NTUyMTczOH0.c1GpOXl-2kwEIv23EYyD2PhR52x9q1QA3F4HHZK4zd4';
        const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
        const state={user:null,profile:null,currentPage:'home',selectedMood:null,selectedTrigger:null,posts:[],currentCategory:'all'};

        function showToast(msg,type='success'){const t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span>${type==='success'?'‚úì':'‚úï'}</span><span>${msg}</span>`;document.getElementById('toastContainer').appendChild(t);setTimeout(()=>t.remove(),3000)}
        function formatTimeAgo(d){const diff=Date.now()-new Date(d),m=Math.floor(diff/60000),h=Math.floor(diff/3600000),dy=Math.floor(diff/86400000);if(m<1)return'Just now';if(m<60)return`${m}m ago`;if(h<24)return`${h}h ago`;if(dy<7)return`${dy}d ago`;return new Date(d).toLocaleDateString()}
        function getInitials(n){return n?n.split(' ').map(x=>x[0]).join('').toUpperCase().slice(0,2):'FS'}
        function escapeHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

        function navigateTo(page){state.currentPage=page;document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(`page-${page}`).classList.add('active');document.querySelectorAll('.nav-item,.mobile-nav-item').forEach(i=>{i.classList.toggle('active',i.dataset.page===page)});if(page==='community')loadPosts();else if(page==='profile')updateProfileUI()}
        document.querySelectorAll('.nav-item,.mobile-nav-item').forEach(i=>i.addEventListener('click',()=>navigateTo(i.dataset.page)));

        async function checkAuth(){const{data:{session}}=await supabase.auth.getSession();if(session){state.user=session.user;await loadProfile()}updateAuthUI()}
        async function loadProfile(){if(!state.user)return;const{data}=await supabase.from('profiles').select('*').eq('user_id',state.user.id).single();if(data)state.profile=data}
        function updateAuthUI(){const logged=!!state.user;document.getElementById('authPrompt').style.display=logged?'none':'block';document.getElementById('profileContent').style.display=logged?'block':'none';document.getElementById('newPostBtn').disabled=!logged;if(logged)updateProfileUI()}
        
        async function updateProfileUI(){if(!state.user)return;const email=state.user.email,username=state.profile?.username||'Fellow Sufferer';document.getElementById('profileAvatar').textContent=getInitials(username);document.getElementById('profileName').textContent=username;document.getElementById('profileEmail').textContent=email;if(state.profile?.suffering_since)document.getElementById('profileSince').textContent=`Suffering since ${new Date(state.profile.suffering_since).toLocaleDateString()}`;await loadUserStats();await loadRecentCheckins()}
        
        async function loadUserStats(){if(!state.user)return;const{count:cc}=await supabase.from('mood_entries').select('*',{count:'exact',head:true}).eq('user_id',state.user.id);document.getElementById('statCheckins').textContent=cc||0;const{count:tc}=await supabase.from('tool_usage').select('*',{count:'exact',head:true}).eq('user_id',state.user.id);document.getElementById('statTools').textContent=tc||0;const{data:md}=await supabase.from('mood_entries').select('intensity').eq('user_id',state.user.id).order('created_at',{ascending:false}).limit(30);if(md&&md.length){const avg=md.reduce((s,m)=>s+m.intensity,0)/md.length;document.getElementById('statAvgMood').textContent=avg.toFixed(1)}await updateMoodChart()}
        
        async function updateMoodChart(){if(!state.user)return;const ago=new Date(Date.now()-7*86400000).toISOString();const{data}=await supabase.from('mood_entries').select('intensity,created_at').eq('user_id',state.user.id).gte('created_at',ago).order('created_at',{ascending:true});if(data&&data.length)document.getElementById('moodChart').innerHTML=data.map(e=>`<div class="mood-bar" style="height:${e.intensity*10}%" title="Intensity: ${e.intensity}"></div>`).join('')}
        
        async function loadRecentCheckins(){if(!state.user)return;const{data}=await supabase.from('mood_entries').select('*').eq('user_id',state.user.id).order('created_at',{ascending:false}).limit(5);const emojis={frustrated:'üò§',anxious:'üò∞',sad:'üòî',numb:'üòê',hopeful:'ü§û',content:'üòä'};if(data&&data.length)document.getElementById('recentCheckinsList').innerHTML=data.map(e=>`<div class="checkin-item"><div class="checkin-emoji">${emojis[e.emotion]||'üòê'}</div><div class="checkin-info"><div class="checkin-emotion">${e.emotion.charAt(0).toUpperCase()+e.emotion.slice(1)}</div><div class="checkin-meta">${formatTimeAgo(e.created_at)}${e.trigger?` ‚Ä¢ ${e.trigger.replace('_',' ')}`:''}</div></div><div class="checkin-intensity">${e.intensity}/10</div></div>`).join('');else document.getElementById('recentCheckinsList').innerHTML='<p style="color:var(--text-muted);text-align:center;padding:1rem">No check-ins yet</p>'}

        document.getElementById('openAuthModal')?.addEventListener('click',()=>document.getElementById('authModal').classList.add('active'));
        document.querySelectorAll('.modal-close').forEach(b=>b.addEventListener('click',()=>b.closest('.modal-overlay').classList.remove('active')));
        document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
        
        document.getElementById('magicLinkForm')?.addEventListener('submit',async e=>{e.preventDefault();const email=document.getElementById('authEmail').value;const btn=document.getElementById('authSubmitBtn');btn.disabled=true;btn.textContent='Sending...';const{error}=await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.origin}});if(error){showToast(error.message,'error');btn.disabled=false;btn.textContent='Send Magic Link'}else{document.getElementById('authForm').style.display='none';document.getElementById('magicLinkSent').classList.add('active');document.getElementById('sentEmail').textContent=email}});
        document.getElementById('resendLink')?.addEventListener('click',async()=>{const email=document.getElementById('sentEmail').textContent;const{error}=await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.origin}});showToast(error?error.message:'Magic link resent!',error?'error':'success')});
        document.getElementById('logoutBtn')?.addEventListener('click',async()=>{await supabase.auth.signOut();state.user=null;state.profile=null;updateAuthUI();showToast('Logged out successfully')});
        
        supabase.auth.onAuthStateChange(async(event,session)=>{if(event==='SIGNED_IN'&&session){state.user=session.user;await loadProfile();updateAuthUI();document.getElementById('authModal').classList.remove('active');document.getElementById('authForm').style.display='block';document.getElementById('magicLinkSent').classList.remove('active');showToast('Welcome to Safe Space COYS!')}else if(event==='SIGNED_OUT'){state.user=null;state.profile=null;updateAuthUI()}});

        document.querySelectorAll('.mood-btn').forEach(b=>b.addEventListener('click',()=>{state.selectedMood={mood:b.dataset.mood,emoji:b.dataset.emoji};state.selectedTrigger=null;document.getElementById('selectedMoodEmoji').textContent=b.dataset.emoji;document.getElementById('selectedMoodLabel').textContent=b.querySelector('.label').textContent;document.getElementById('intensitySlider').value=5;document.querySelectorAll('.trigger-btn').forEach(t=>t.classList.remove('active'));document.getElementById('moodModal').classList.add('active')}));
        document.querySelectorAll('.trigger-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.trigger-btn').forEach(t=>t.classList.remove('active'));b.classList.add('active');state.selectedTrigger=b.dataset.trigger}));
        document.getElementById('checkinBack')?.addEventListener('click',()=>document.getElementById('moodModal').classList.remove('active'));
        document.getElementById('checkinSave')?.addEventListener('click',async()=>{if(!state.user){document.getElementById('moodModal').classList.remove('active');document.getElementById('authModal').classList.add('active');return}const{error}=await supabase.from('mood_entries').insert({user_id:state.user.id,emotion:state.selectedMood.mood,intensity:parseInt(document.getElementById('intensitySlider').value),trigger:state.selectedTrigger});if(error)showToast('Failed to save check-in','error');else{showToast('Check-in saved!');document.getElementById('moodModal').classList.remove('active');if(state.currentPage==='profile'){await loadUserStats();await loadRecentCheckins()}}});

        async function loadPosts(){document.getElementById('postsList').innerHTML='<div class="loading-spinner"><div class="spinner"></div></div>';let query=supabase.from('posts_with_author').select('*').order('created_at',{ascending:false}).limit(50);if(state.currentCategory!=='all')query=query.eq('category',state.currentCategory);const{data,error}=await query;if(error){document.getElementById('postsList').innerHTML='<div class="empty-state"><div class="empty-state-icon">üòï</div><p>Failed to load posts</p></div>';return}state.posts=data||[];if(!state.posts.length){document.getElementById('postsList').innerHTML='<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No posts yet. Be the first to share!</p></div>';return}let userLikes=[];if(state.user){const{data:ld}=await supabase.from('likes').select('post_id').eq('user_id',state.user.id);userLikes=ld?.map(l=>l.post_id)||[]}document.getElementById('postsList').innerHTML=state.posts.map(p=>renderPost(p,userLikes)).join('');attachPostListeners()}

        function renderPost(post,userLikes=[]){const isLiked=userLikes.includes(post.id),isOwner=state.user?.id===post.user_id;const cats={match_day:'Match Day',mental_health:'Mental Health',general:'General',support_needed:'Support',celebrations:'Celebration'};return`<article class="post-card" data-post-id="${post.id}"><div class="post-header"><div class="post-author"><div class="author-avatar">${getInitials(post.display_name)}</div><div class="author-info"><div class="author-name">${post.display_name||'Anonymous Yiddo'}</div><div class="post-meta"><span>${formatTimeAgo(post.created_at)}</span><span class="post-category">${cats[post.category]||post.category}</span></div></div></div><div class="post-type-badge ${post.post_type}">${post.post_type==='vent'?'üò§ Vent':'ü§ù Support'}</div>${isOwner?`<div class="post-menu"><button class="post-menu-btn" data-menu-toggle="${post.id}">‚ãÆ</button><div class="post-menu-dropdown" data-menu="${post.id}"><button class="post-menu-item danger" data-delete-post="${post.id}">Delete Post</button></div></div>`:''}</div><div class="post-content">${escapeHtml(post.content)}</div><div class="post-actions"><button class="post-action-btn ${isLiked?'liked':''}" data-like-post="${post.id}">${isLiked?'‚ù§Ô∏è':'ü§ç'} <span>${post.likes_count||0}</span></button><button class="post-action-btn" data-toggle-comments="${post.id}">üí¨ <span>${post.comments_count||0}</span></button></div><div class="comments-section" data-comments-section="${post.id}"><div class="comments-list" data-comments-list="${post.id}"></div>${state.user?`<form class="comment-form" data-comment-form="${post.id}"><input type="text" class="comment-input" placeholder="Write a comment..." maxlength="1000" required><button type="submit" class="comment-submit">Send</button></form>`:''}</div></article>`}

        function attachPostListeners(){document.querySelectorAll('[data-like-post]').forEach(b=>b.addEventListener('click',()=>toggleLike(b.dataset.likePost)));document.querySelectorAll('[data-toggle-comments]').forEach(b=>b.addEventListener('click',()=>toggleComments(b.dataset.toggleComments)));document.querySelectorAll('[data-menu-toggle]').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();const menu=document.querySelector(`[data-menu="${b.dataset.menuToggle}"]`);document.querySelectorAll('.post-menu-dropdown.active').forEach(m=>{if(m!==menu)m.classList.remove('active')});menu.classList.toggle('active')}));document.querySelectorAll('[data-delete-post]').forEach(b=>b.addEventListener('click',()=>deletePost(b.dataset.deletePost)));document.querySelectorAll('[data-comment-form]').forEach(f=>f.addEventListener('submit',e=>{e.preventDefault();submitComment(f.dataset.commentForm,f.querySelector('input').value);f.querySelector('input').value=''}));document.addEventListener('click',()=>document.querySelectorAll('.post-menu-dropdown.active').forEach(m=>m.classList.remove('active')))}

        async function toggleLike(postId){if(!state.user){document.getElementById('authModal').classList.add('active');return}const btn=document.querySelector(`[data-like-post="${postId}"]`),isLiked=btn.classList.contains('liked'),count=parseInt(btn.querySelector('span').textContent);if(isLiked){await supabase.from('likes').delete().eq('post_id',postId).eq('user_id',state.user.id);btn.classList.remove('liked');btn.innerHTML=`ü§ç <span>${count-1}</span>`}else{await supabase.from('likes').insert({post_id:postId,user_id:state.user.id});btn.classList.add('liked');btn.innerHTML=`‚ù§Ô∏è <span>${count+1}</span>`}}

        async function toggleComments(postId){const section=document.querySelector(`[data-comments-section="${postId}"]`);if(section.classList.contains('active'))section.classList.remove('active');else{section.classList.add('active');await loadComments(postId)}}

        async function loadComments(postId){const list=document.querySelector(`[data-comments-list="${postId}"]`);list.innerHTML='<div class="loading-spinner"><div class="spinner" style="width:24px;height:24px"></div></div>';const{data}=await supabase.from('comments_with_author').select('*').eq('post_id',postId).order('created_at',{ascending:true});if(!data||!data.length){list.innerHTML='<p style="color:var(--text-muted);font-size:.875rem;padding:.5rem 0">No comments yet</p>';return}const top=data.filter(c=>!c.parent_id),replies=data.filter(c=>c.parent_id);list.innerHTML=top.map(c=>renderComment(c,replies,postId)).join('');list.querySelectorAll('.reply-btn[data-reply-to]').forEach(b=>b.addEventListener('click',()=>{const inp=document.querySelector(`[data-reply-input="${b.dataset.replyTo}"]`);if(inp)inp.style.display=inp.style.display==='none'?'flex':'none'}));list.querySelectorAll('[data-reply-form]').forEach(f=>f.addEventListener('submit',e=>{e.preventDefault();submitComment(f.dataset.postId,f.querySelector('input').value,f.dataset.replyForm);f.querySelector('input').value=''}));list.querySelectorAll('[data-delete-comment]').forEach(b=>b.addEventListener('click',async()=>{if(!confirm('Delete this comment?'))return;await supabase.from('comments').delete().eq('id',b.dataset.deleteComment);loadComments(postId);const btn=document.querySelector(`[data-toggle-comments="${postId}"] span`);if(btn)btn.textContent=parseInt(btn.textContent)-1}))}

        function renderComment(c,allReplies,postId){const children=allReplies.filter(r=>r.parent_id===c.id),isOwner=state.user?.id===c.user_id;return`<div class="comment" data-comment-id="${c.id}"><div class="comment-header"><div class="comment-author"><div class="comment-avatar">${getInitials(c.display_name)}</div><span class="comment-author-name">${c.display_name||'Anonymous Yiddo'}</span></div><span class="comment-time">${formatTimeAgo(c.created_at)}</span></div><div class="comment-content">${escapeHtml(c.content)}</div><div class="comment-actions">${state.user?`<button class="reply-btn" data-reply-to="${c.id}">Reply</button>`:''} ${isOwner?`<button class="reply-btn" style="color:var(--danger)" data-delete-comment="${c.id}">Delete</button>`:''}</div>${state.user?`<form class="comment-form" style="display:none;margin-left:36px;margin-top:.5rem" data-reply-input="${c.id}" data-reply-form="${c.id}" data-post-id="${postId}"><input type="text" class="comment-input" placeholder="Write a reply..." maxlength="1000" required><button type="submit" class="comment-submit">Reply</button></form>`:''}${children.length?`<div class="nested-comments">${children.map(r=>renderComment(r,allReplies,postId)).join('')}</div>`:''}</div>`}

        async function submitComment(postId,content,parentId=null){if(!state.user||!content.trim())return;const{error}=await supabase.from('comments').insert({post_id:postId,user_id:state.user.id,parent_id:parentId,content:content.trim()});if(error)showToast('Failed to post comment','error');else{await loadComments(postId);const btn=document.querySelector(`[data-toggle-comments="${postId}"] span`);if(btn)btn.textContent=parseInt(btn.textContent)+1}}

        async function deletePost(postId){if(!confirm('Delete this post?'))return;const{error}=await supabase.from('posts').delete().eq('id',postId);if(error)showToast('Failed to delete post','error');else{showToast('Post deleted');loadPosts()}}

        document.querySelectorAll('.category-filter').forEach(f=>f.addEventListener('click',()=>{document.querySelectorAll('.category-filter').forEach(x=>x.classList.remove('active'));f.classList.add('active');state.currentCategory=f.dataset.category;loadPosts()}));
        document.getElementById('newPostBtn')?.addEventListener('click',()=>{if(!state.user){document.getElementById('authModal').classList.add('active');return}document.getElementById('postComposer').classList.toggle('active');if(document.getElementById('postComposer').classList.contains('active'))document.getElementById('postContent').focus()});
        document.getElementById('cancelPost')?.addEventListener('click',()=>{document.getElementById('postComposer').classList.remove('active');document.getElementById('postContent').value=''});
        document.getElementById('submitPost')?.addEventListener('click',async()=>{if(!state.user)return;const content=document.getElementById('postContent').value.trim();if(!content){showToast('Please write something','error');return}document.getElementById('submitPost').disabled=true;const{error}=await supabase.from('posts').insert({user_id:state.user.id,content,category:document.getElementById('postCategory').value,post_type:document.getElementById('postType').value,is_anonymous:document.getElementById('postAnonymous').checked});document.getElementById('submitPost').disabled=false;if(error)showToast('Failed to create post','error');else{showToast('Post created!');document.getElementById('postComposer').classList.remove('active');document.getElementById('postContent').value='';document.getElementById('postAnonymous').checked=false;loadPosts()}});

        const tools={breathing:{title:'Box Breathing',steps:['Breathe in for 4 seconds','Hold for 4 seconds','Breathe out for 4 seconds','Hold for 4 seconds']},grounding:{title:'5-4-3-2-1 Grounding',steps:[{prompt:'5 things you can SEE',count:5},{prompt:'4 things you can TOUCH',count:4},{prompt:'3 things you can HEAR',count:3},{prompt:'2 things you can SMELL',count:2},{prompt:'1 thing you can TASTE',count:1}]},reframe:{title:'Thought Reframing',prompts:['What negative thought is bothering you?','What evidence supports this thought?','What evidence contradicts this thought?','What would you tell a friend thinking this?','Can you reframe this thought more realistically?']},affirmations:{title:'Spurs Fan Affirmations',items:["My worth isn't determined by the score.","It's okay to feel disappointed. I'm human.","Supporting Spurs has taught me resilience.","I can enjoy the beautiful game regardless of results.","The community I've found through football is meaningful.","My emotions about football are valid.","I choose how much this affects my day.","There's always next match. There's always hope."]}};
        let currentToolStep=0,currentTool=null,breathingInterval=null;

        document.querySelectorAll('[data-tool]').forEach(b=>b.addEventListener('click',()=>openTool(b.dataset.tool)));
        function openTool(toolId){currentTool=toolId;currentToolStep=0;document.getElementById('toolModalTitle').textContent=tools[toolId].title;renderToolStep();document.getElementById('toolModal').classList.add('active');if(state.user)supabase.from('tool_usage').insert({user_id:state.user.id,tool_name:toolId})}

        function renderToolStep(){if(currentTool==='breathing')renderBreathing();else if(currentTool==='grounding')renderGrounding();else if(currentTool==='reframe')renderReframe();else if(currentTool==='affirmations')renderAffirmations()}

        function renderBreathing(){const steps=tools.breathing.steps,step=steps[currentToolStep%4],isInhale=currentToolStep%4===0;document.getElementById('toolContent').innerHTML=`<p style="color:var(--text-secondary);margin-bottom:1rem">Round ${Math.floor(currentToolStep/4)+1} of 3</p><div class="breathing-circle ${isInhale?'inhale':''}">${step}</div><div class="tool-nav"><button class="tool-prev" onclick="closeTool()">End Exercise</button><button class="tool-next" onclick="nextBreathingStep()">Next</button></div>`;clearTimeout(breathingInterval);breathingInterval=setTimeout(()=>{if(currentToolStep<11)nextBreathingStep();else document.getElementById('toolContent').innerHTML=`<div style="text-align:center"><p style="font-size:3rem;margin-bottom:1rem">‚ú®</p><h3>Great job!</h3><p style="color:var(--text-secondary);margin:1rem 0">You completed 3 rounds of box breathing.</p><button class="tool-next" onclick="closeTool()">Done</button></div>`},4000)}
        window.nextBreathingStep=function(){currentToolStep++;renderBreathing()};

        function renderGrounding(){const steps=tools.grounding.steps;if(currentToolStep>=steps.length){document.getElementById('toolContent').innerHTML=`<div style="text-align:center"><p style="font-size:3rem;margin-bottom:1rem">üéØ</p><h3>You're grounded!</h3><p style="color:var(--text-secondary);margin:1rem 0">Take a moment to notice how you feel now.</p><button class="tool-next" onclick="closeTool()">Done</button></div>`;return}const step=steps[currentToolStep];document.getElementById('toolContent').innerHTML=`<div style="text-align:center;margin:2rem 0"><h3 style="margin-bottom:.5rem">${step.prompt}</h3><p style="color:var(--text-muted);font-size:.875rem">Name ${step.count} thing${step.count>1?'s':''}</p></div><div class="tool-nav">${currentToolStep>0?'<button class="tool-prev" onclick="prevToolStep()">Back</button>':''}<button class="tool-next" onclick="nextToolStep()">Next</button></div>`}

        function renderReframe(){const prompts=tools.reframe.prompts;if(currentToolStep>=prompts.length){document.getElementById('toolContent').innerHTML=`<div style="text-align:center"><p style="font-size:3rem;margin-bottom:1rem">üß†</p><h3>Well done!</h3><p style="color:var(--text-secondary);margin:1rem 0">You've examined your thought from multiple angles.</p><button class="tool-next" onclick="closeTool()">Done</button></div>`;return}document.getElementById('toolContent').innerHTML=`<div class="thought-reframe"><p style="color:var(--text-secondary);margin-bottom:.5rem">Step ${currentToolStep+1} of ${prompts.length}</p><h3 style="margin-bottom:1rem">${prompts[currentToolStep]}</h3><textarea placeholder="Type your thoughts here..."></textarea></div><div class="tool-nav">${currentToolStep>0?'<button class="tool-prev" onclick="prevToolStep()">Back</button>':''}<button class="tool-next" onclick="nextToolStep()">Next</button></div>`}

        function renderAffirmations(){const items=tools.affirmations.items,item=items[currentToolStep%items.length];document.getElementById('toolContent').innerHTML=`<p style="color:var(--text-secondary);margin-bottom:1rem;text-align:center">${currentToolStep+1} of ${items.length}</p><div class="affirmation-card">"${item}"</div><p style="color:var(--text-muted);font-size:.875rem;text-align:center">Take a breath and let this sink in.</p><div class="tool-nav">${currentToolStep>0?'<button class="tool-prev" onclick="prevToolStep()">Previous</button>':''}${currentToolStep<items.length-1?'<button class="tool-next" onclick="nextToolStep()">Next</button>':'<button class="tool-next" onclick="closeTool()">Done</button>'}</div>`}

        window.nextToolStep=function(){currentToolStep++;renderToolStep()};
        window.prevToolStep=function(){currentToolStep--;renderToolStep()};
        window.closeTool=function(){clearTimeout(breathingInterval);document.getElementById('toolModal').classList.remove('active')};

        function updateDroughtCounter(){const last=new Date('2008-02-24'),diff=Math.floor((Date.now()-last)/86400000);document.getElementById('droughtDays').textContent=diff.toLocaleString()}
        function updateMatchCountdown(){const next=new Date('2026-02-05T15:00:00'),diff=next-Date.now();if(diff<=0){['countDays','countHours','countMins','countSecs'].forEach(id=>document.getElementById(id).textContent='0');return}document.getElementById('countDays').textContent=Math.floor(diff/86400000);document.getElementById('countHours').textContent=Math.floor((diff%86400000)/3600000);document.getElementById('countMins').textContent=Math.floor((diff%3600000)/60000);document.getElementById('countSecs').textContent=Math.floor((diff%60000)/1000)}

        async function init(){await checkAuth();updateDroughtCounter();updateMatchCountdown();setInterval(updateMatchCountdown,1000);const hash=new URLSearchParams(window.location.hash.substring(1));if(hash.get('access_token'))window.location.hash=''}
        init();
    </script>
</body>
</html>
